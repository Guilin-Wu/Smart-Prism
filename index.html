<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧棱镜系统</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts-datatool/2.0.1/dataTool.min.js"></script>

    <script src="https://cdn.bootcdn.net/ajax/libs/marked/12.0.0/marked.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/mhchem.min.js"></script>


    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>🪞智慧棱镜系统</h2>
                <h2>SMART PRISM</h2>
            </div>

            <ul>
                <li class="config-section" id="class-filter-container" style="display: none;">
                    <h4>班级筛选</h4>
                    <select id="class-filter" class="sidebar-select"></select>
                </li>
                <hr id="class-filter-hr" style="display: none;">

                <li class="config-section">
                    <h4>考试配置</h4>
                    <button id="config-subjects-btn" class="sidebar-button">
                        ⚙️ 配置各科满分
                    </button>
                </li>
                <hr>

                <li><a href="#" class="nav-link active" data-module="dashboard">📈 班级整体分析</a></li>
                <li><a href="#" class="nav-link" data-module="student">👩‍🎓 学生个体报告</a></li>
                <li><a href="#" class="nav-link" data-module="paper">📝 试卷科目分析</a></li>
                <li><a href="#" class="nav-link" data-module="single-subject">🎯 单科成绩分析</a></li>
                <li><a href="#" class="nav-link" data-module="boundary">📊 临界生分析</a></li>
                <li><a href="#" class="nav-link" data-module="holistic">⚖️ 全科均衡分析</a></li>
                <li><a href="#" class="nav-link" data-module="trend-distribution">🌊 成绩分布变动</a></li>
                <li><a href="#" class="nav-link" data-module="groups">🎯 学生分层筛选</a></li>
                <li><a href="#" class="nav-link" data-module="correlation">🌡️ 学科关联矩阵</a></li>
                <li><a href="#" class="nav-link" data-module="weakness">📉 偏科诊断分析</a></li>
                <li><a href="#" class="nav-link" data-module="trend">🚀 成绩趋势对比</a></li>
                <li><a href="#" class="nav-link" data-module="multi-exam">📈 多次考试分析</a></li>
                <li><a href="#" class="nav-link" data-module="item-analysis">🔬 学科小题分析</a></li>

                <li><a href="#" class="nav-link" data-module="ai-advisor">🤖 AI 智能分析</a></li>

                <hr style="margin-top: 20px; border-color: var(--border-color);">

                <li>
                    <label id="import-main-btn" class="upload-label">
                        📊 导入本次成绩
                    </label>
                    <input type="file" id="file-uploader" accept=".xlsx, .xls, .csv" style="display: none;">
                </li>
                <li>
                    <label id="import-compare-btn" class="upload-label">
                        📉 导入对比成绩
                    </label>
                    <input type="file" id="file-uploader-compare" accept=".xlsx, .xls, .csv" style="display: none;">
                </li>

                <li>
                    <button id="clear-all-data-btn" class="sidebar-button"
                        style="width: 100%; background-color: var(--color-red); margin-top: 10px;">
                        🗑️ 清除所有导入数据
                    </button>
                </li>
                <li><a href="#" class="nav-link">✍️ 作者：G.L.Wu</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div id="welcome-screen">
                <h2>欢迎使用成绩分析系统</h2>
                <p>请点击左侧 "📊 导入本次成绩" 开始分析。</p>
            </div>

            <div id="module-dashboard" class="module-panel"></div>
            <div id="module-student" class="module-panel"></div>
            <div id="module-paper" class="module-panel"></div>
            <div id="module-single-subject" class="module-panel"></div>
            <div id="module-boundary" class="module-panel"></div>
            <div id="module-holistic" class="module-panel"></div>
            <div id="module-trend-distribution" class="module-panel"></div>
            <div id="module-groups" class="module-panel"></div>
            <div id="module-correlation" class="module-panel"></div>
            <div id="module-weakness" class="module-panel"></div>
            <div id="module-trend" class="module-panel"></div>
            <div id="module-multi-exam" class="module-panel"></div>
            <div id="module-item-analysis" class="module-panel"></div>

            <div id="module-ai-advisor" class="module-panel">
                <h2>模块十四：AI 智能分析</h2>
                <p>AI 智能分析模块基于 DeepSeek 模型，提供以下功能：</p>
                <ul>
                    <li>分析学生历史成绩趋势</li>
                    <li>识别学生偏科情况</li>
                    <li>提供个性化学习建议</li>
                </ul>
                <p style="color: var(--text-muted);">基于 DeepSeek模型，分析学生历史成绩趋势与偏科情况，提供个性化建议。</p>

                <button id="ai-history-toggle-btn" title="查看历史记录">
                    🕒 历史
                </button>

                <div id="ai-history-drawer">
                    <div class="history-header">
                        <h3>🕒 对话历史</h3>
                        <button id="ai-history-close-btn">&times;</button>
                    </div>

                    <div class="history-actions">
                        <button id="ai-history-clear-btn" class="sidebar-button"
                            style="background-color: var(--color-red); width: 100%; font-size: 0.85em;">
                            🗑️ 清空所有记录
                        </button>
                    </div>

                    <div id="ai-history-list" class="history-list-container">
                        <p style="color: #999; text-align: center; margin-top: 20px;">暂无历史记录</p>
                    </div>
                </div>

                <div class="main-card-wrapper"
                    style="margin-bottom: 20px; border-left: 5px solid var(--primary-color);">
                    <h4>🔑 API 设置</h4>
                    <div class="controls-bar" style="background: transparent; box-shadow: none; padding: 0;">
                        <label for="ai-api-key">DeepSeek API Key:</label>
                        <input type="password" id="ai-api-key" placeholder="sk-..."
                            style="flex-grow: 1; max-width: 400px;">
                        <button id="ai-save-key-btn" class="sidebar-button">保存 Key</button>
                        <span id="ai-key-status" style="margin-left: 10px; color: var(--color-green); display: none;">✅
                            已保存</span>
                    </div>
                    <p style="font-size: 0.8em; color: var(--text-muted); margin-top: 5px;">
                        * Key 仅保存在您的浏览器本地，不会上传到任何服务器。
                    </p>
                </div>

                <div class="main-card-wrapper" style="margin-bottom: 20px;">
                    <h4>🎯 选择分析对象</h4>
                    <div class="controls-bar"
                        style="background: transparent; box-shadow: none; padding: 0; flex-wrap: wrap;">

                        <div class="search-combobox">
                            <input type="text" id="ai-student-search" placeholder="输入姓名或考号..." autocomplete="off">
                            <div class="search-results" id="ai-student-search-results"></div>
                        </div>

                        <select id="ai-grade-select" class="sidebar-select" style="margin-left: 10px; width: auto;">
                            <option value="一年级">一年级</option>
                            <option value="二年级">二年级</option>
                            <option value="三年级">三年级</option>
                            <option value="四年级">四年级</option>
                            <option value="五年级">五年级</option>
                            <option value="六年级">六年级</option>

                            <option value="初一">初一</option>
                            <option value="初二">初二</option>
                            <option value="初三">初三</option>

                            <option value="高一" selected>高一</option>
                            <option value="高二">高二</option>
                            <option value="高三">高三</option>
                        </select>

                        <select id="ai-mode-select" class="sidebar-select" style="margin-left: 15px;">
                            <option value="trend">📈 综合趋势点评 & 学习建议</option>
                            <option value="weakness">📉 弱科诊断 & 提分策略</option>
                            <option value="question">📝 针对弱项生成练习题</option>
                            <option value="item_diagnosis">🔬 小题深度诊断 (学生视角)</option>
                            <option value="teaching_guide">🍎 教师教学指导 (班级视角)</option>
                        </select>

                        <span id="ai-item-subject-wrapper"
                            style="display: none; margin-left: 10px; align-items: center;">
                            <label for="ai-item-subject"
                                style="margin-right: 5px; font-size: 0.9em; color: #555;">科目:</label>
                            <select id="ai-item-subject" class="sidebar-select"
                                style="width: auto; min-width: 80px; border-color: #17a2b8; background-color: #f0fcfd;">
                                <option value="">无数据</option>
                            </select>
                        </span>

                        <span id="ai-item-class-wrapper" style="display: none; margin-left: 10px; align-items: center;">
                            <label for="ai-item-class"
                                style="margin-right: 5px; font-size: 0.9em; color: #555;">班级:</label>
                            <select id="ai-item-class" class="sidebar-select"
                                style="width: auto; min-width: 80px; border-color: #fd7e14; background-color: #fffbf5;">
                                <option value="ALL">-- 全体年段 --</option>
                            </select>
                        </span>

                        <span id="ai-q-count-wrapper" style="display: none; margin-left: 10px; align-items: center;">
                            <label for="ai-q-count" style="margin-right: 5px; font-size: 0.9em;">题量:</label>
                            <input type="number" id="ai-q-count" value="3" min="1" max="10" class="sidebar-select"
                                style="width: 60px; padding: 6px;">
                        </span>

                        <select id="ai-model-select" class="sidebar-select"
                            style="margin-left: 10px; background-color: #f0fdf4; border-color: #28a745;">
                            <option value="deepseek-chat">🚀 V3 (标准极速版)</option>
                            <option value="deepseek-reasoner">🧠 R1 (深度思考版)</option>
                        </select>

                        <button id="ai-analyze-btn" class="sidebar-button"
                            style="background-color: #6f42c1; margin-left: 15px;" disabled>
                            ✨ 开始 AI 分析
                        </button>
                    </div>
                </div>

                <div class="main-card-wrapper" id="ai-result-container" style="display: none; min-height: 300px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <h3 style="margin: 0;">🤖 DeepSeek 回复:</h3>
                            <button id="ai-stop-btn" class="sidebar-button"
                                style="background-color: #dc3545; padding: 4px 12px; font-size: 0.85em; display: none;">
                                ⏹ 停止生成
                            </button>
                            <button id="ai-print-btn" class="sidebar-button" ...>🖨️ 打印报告</button>
                            <button id="ai-copy-btn" class="sidebar-button"
                                style="font-size: 0.8em; padding: 4px 8px; background-color: var(--color-gray);">复制内容</button>
                        </div>
                    </div>

                    <div id="ai-loading" style="display: none; text-align: center; padding: 40px;">
                        <div style="font-size: 2em;">🤔</div>
                        <p>AI 正在思考学生的成绩数据...</p>
                    </div>

                    <div id="ai-content" style="line-height: 1.6; font-size: 1.05em;"></div>

                    <div id="ai-chat-history" style="margin-top: 20px; border-top: 1px dashed #eee; padding-top: 20px;">
                    </div>

                    <div id="ai-followup-input-area"
                        style="display: none; margin-top: 15px; gap: 10px; align-items: flex-start;">
                        <textarea id="ai-user-input" class="sidebar-select" rows="1"
                            placeholder="继续追问 AI (例如：根据掌握不扎实的知识点出一套题目...)"
                            style="flex-grow: 1; resize: none; height: 40px; padding: 10px; line-height: 20px;"></textarea>
                        <button id="ai-send-btn" class="sidebar-button"
                            style="height: 42px; background-color: var(--primary-color); white-space: nowrap; flex-shrink: 0; width: 80px;">发送</button>
                    </div>
        </main>
    </div>

    <div id="subject-config-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>配置各科满分/及格线/优秀线</h3>
                <span id="modal-close-btn" class="modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p>默认值已设为“语数英150，其他100”。</p>
                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                    <table id="subject-config-table">
                        <thead>
                            <tr>
                                <th>科目</th>
                                <th>满分 (Full)</th>
                                <th>优秀线 (Excel)</th>
                                <th>良好线 (Good)</th>
                                <th>及格线 (Pass)</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button id="modal-save-btn" class="sidebar-button">保存并重新分析</button>
            </div>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="import-modal-title">选择数据源</h3>
                <span id="import-modal-close-btn" class="modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <h4>1. 从“多次考试分析”模块导入</h4>
                <p>选择一个您在“模块十二”中已保存的成绩单。</p>
                <select id="import-modal-select" class="sidebar-select" style="width: 100%;"></select>
                <button id="import-modal-from-storage" class="sidebar-button" style="width: 100%; margin-top: 10px;">
                    导入选中项
                </button>
                <hr style="margin: 20px 0;">
                <h4>2. 从本地文件导入</h4>
                <p>像以前一样，从您的电脑上传一个新文件。</p>
                <button id="import-modal-from-file" class="sidebar-button"
                    style="width: 100%; background-color: var(--color-gray);">
                    从本地文件上传
                </button>
            </div>
        </div>
    </div>

    <div id="item-analysis-config-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="item-config-modal-title">配置题目详情 (科目: -)</h3>
                <span id="item-config-modal-close-btn" class="modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p>
                    “满分”：留空则使用自动检测的满分 (见灰色提示文字)。手动填写数字将覆盖自动检测，并用于重新计算得分率。
                    <br>
                    “考察内容”：填写本题的知识点，方便后续分析。
                </p>
                <div class="table-container" style="max-height: 50vh; overflow-y: auto;">
                    <table id="item-config-table">
                        <thead>
                            <tr>
                                <th>题号 (类型)</th>
                                <th>满分 (留空=自动)</th>
                                <th>考察内容 (知识点)</th>
                            </tr>
                        </thead>
                        <tbody id="item-config-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button id="item-config-modal-save-btn" class="sidebar-button">保存并重新分析</button>
            </div>
        </div>
    </div>

    <div id="print-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>选择打印范围</h3>
                <span id="print-modal-close-btn" class="modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p>请选择您要打印的学生范围。这可能需要几秒钟时间来生成所有报告。</p>

                <button id="print-btn-current" class="sidebar-button" style="width: 100%; margin-top: 10px;" disabled>
                    🖨️ 打印当前学生 (未选择)
                </button>

                <button id="print-btn-filter" class="sidebar-button"
                    style="width: 100%; margin-top: 10px; background-color: var(--color-green);">
                    🖨️ 打印当前筛选 (全体年段)
                </button>

                <p style="color: var(--text-muted); font-size: 0.9em; margin-top: 15px;">
                    “打印当前筛选”会打印您在左侧边栏选择的班级（例如 "高一(1)班" 或 "全体年段"）。
                </p>
            </div>
        </div>
    </div>

    <div id="item-print-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>选择打印范围 (小题分析)</h3>
                <span id="item-print-modal-close-btn" class="modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p>请选择您要打印的学生诊断报告范围。</p>

                <button id="item-print-btn-current" class="sidebar-button" style="width: 100%; margin-top: 10px;"
                    disabled>
                    🖨️ 打印当前学生 (未选择)
                </button>

                <button id="item-print-btn-filter" class="sidebar-button"
                    style="width: 100%; margin-top: 10px; background-color: var(--color-green);">
                    🖨️ 打印当前筛选 (全体)
                </button>

                <p style="color: var(--text-muted); font-size: 0.9em; margin-top: 15px;">
                    “打印当前筛选”会打印您在小题分析模块选择的班级（例如 "高一(1)班" 或 "全体"）。
                </p>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>

</html>